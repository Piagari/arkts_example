/**
 * È¶ñÈ°µ
 */
import { AppCard } from '../components/AppCard';
import { AppColors } from '../theme/AppColors';
import { AppDimensions } from '../theme/AppDimensions';
import { AppTypography } from '../theme/AppTypography';
import { mockBanners, mockCategories, mockCoupons, mockGoods } from '../data/MockData';
import { Goods, Banner, Category, Coupon } from '../models/CommonModels';

@Component
@Entry
export struct HomePage {
  @State banners: Array<Banner> = mockBanners;
  @State categories: Array<Category> = mockCategories;
  @State coupons: Array<Coupon> = mockCoupons;
  @State goods: Goods[] = mockGoods;
  @State flashSaleGoods: Goods[] = mockGoods.slice(0, 5);
  @State recommendGoods: Goods[] = mockGoods.slice(0, 3);

  build() {
    Column() {
      // È°∂ÈÉ®ÊêúÁ¥¢Ê†è
      this.SearchBar()

      // ‰∏ªÂÜÖÂÆπÊªöÂä®Âå∫Âüü
      Scroll() {
        Column({ space: AppDimensions.spaceMedium }) {
          // ËΩÆÊí≠Âõæ
          this.BannerSwiper()

          // ‰ºòÊÉ†Âà∏
          this.CouponSection()

          // ÂàÜÁ±ª
          this.CategoryGrid()

          // ÈôêÊó∂Á≤æÈÄâ
          this.FlashSaleSection()

          // Êé®ËçêÂïÜÂìÅ
          this.RecommendSection()

          // ÂÖ®ÈÉ®ÂïÜÂìÅ
          this.AllGoodsSection()
        }
        .padding(AppDimensions.paddingMedium)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.background)
  }

  // ÊêúÁ¥¢Ê†è
  @Builder
  SearchBar() {
    Row() {
      // Logo
      Image($r('app.media.startIcon'))
        .width(34)
        .height(34)
        .borderRadius(AppDimensions.radiusSmall)

      // ÊêúÁ¥¢Ê°Ü
      Row({ space: AppDimensions.spaceSmall }) {
        Text('üîç')
          .fontSize(16)

        Text('ÊêúÁ¥¢ÂïÜÂìÅ')
          .fontSize(AppTypography.fontSizeMedium)
          .fontColor(AppColors.textSecondary)
      }
      .layoutWeight(1)
      .height(38)
      .backgroundColor(AppColors.surface)
      .borderRadius(AppDimensions.radiusMedium)
      .padding({ left: AppDimensions.paddingMedium, right: AppDimensions.paddingMedium })
      .margin({ left: AppDimensions.spaceMedium, right: AppDimensions.spaceMedium })
      .justifyContent(FlexAlign.Center)

      // GitHub ÂõæÊ†á
      Text('‚Üó')
        .fontSize(24)
        .fontColor(AppColors.onBackground)
    }
    .width('100%')
    .height(56)
    .backgroundColor(AppColors.background)
    .padding({ left: AppDimensions.paddingMedium, right: AppDimensions.paddingMedium })
  }

  // ËΩÆÊí≠Âõæ
  @Builder
  BannerSwiper() {
    Swiper() {
      ForEach(this.banners, (banner: Banner) => {
        Image(banner.pic)
          .width('100%')
          .aspectRatio(2)
          .borderRadius(AppDimensions.radiusMedium)
          .objectFit(ImageFit.Cover)
      })
    }
    .autoPlay(true)
    .interval(3000)
    .indicator(true)
    .loop(true)
    .width('100%')
    .aspectRatio(2)
    .borderRadius(AppDimensions.radiusMedium)
  }

  // ‰ºòÊÉ†Âà∏Âå∫Âüü
  @Builder
  CouponSection() {
    Column() {
      Row() {
        // ‰ºòÊÉ†Âà∏ÂÜÖÂÆπ
        Row({ space: AppDimensions.spaceSmall }) {
          Text('üéüÔ∏è')
            .fontSize(16)

          Text(this.coupons[0]?.title || '')
            .fontSize(AppTypography.fontSizeMedium)
            .fontColor(AppColors.textPrimary)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)
        }
        .layoutWeight(1)

        // ÂàÜÂâ≤Á∫ø
        Divider()
          .vertical(true)
          .height(20)
          .color(AppColors.divider)
          .strokeWidth(0.5)
          .margin({ left: AppDimensions.spaceMedium, right: AppDimensions.spaceMedium })

        // È¢ÜÂèñÊåâÈíÆ
        Text('È¢ÜÂèñ')
          .fontSize(AppTypography.fontSizeMedium)
          .fontColor(AppColors.primary)
      }
      .width('100%')
    }
    .width('100%')
    .backgroundColor(AppColors.surface)
    .borderRadius(AppDimensions.radiusMedium)
    .padding(AppDimensions.paddingMedium)
  }

  // ÂàÜÁ±ªÁΩëÊ†º
  @Builder
  CategoryGrid() {
    Column() {
      Grid() {
        ForEach(this.categories, (category: Category) => {
          GridItem() {
            Column({ space: AppDimensions.spaceXSmall }) {
              Image(category.pic)
                .width('80%')
                .aspectRatio(1)
                .borderRadius(AppDimensions.radiusRound)
                .objectFit(ImageFit.Cover)

              Text(category.name)
                .fontSize(AppTypography.fontSizeMedium)
                .fontColor(AppColors.textPrimary)
            }
            .width('100%')
            .padding(AppDimensions.paddingXSmall)
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
      .rowsGap(AppDimensions.spaceSmall)
      .columnsGap(AppDimensions.spaceSmall)
      .width('100%')
    }
    .width('100%')
    .backgroundColor(AppColors.surface)
    .borderRadius(AppDimensions.radiusMedium)
    .padding(AppDimensions.paddingLarge)
  }

  // ÈôêÊó∂Á≤æÈÄâ
  @Builder
  FlashSaleSection() {
    Column() {
      Column({ space: AppDimensions.spaceMedium }) {
        // Ê†áÈ¢òË°å
        Row() {
          Row({ space: AppDimensions.spaceSmall }) {
            Text('‚è∞')
              .fontSize(20)

            Text('ÈôêÊó∂Á≤æÈÄâ')
              .fontSize(AppTypography.fontSizeLarge)
              .fontWeight(AppTypography.fontWeightMedium)
              .fontColor(AppColors.textPrimary)
          }

          Blank()

          Text('Êü•ÁúãÂÖ®ÈÉ®')
            .fontSize(AppTypography.fontSizeMedium)
            .fontColor(AppColors.textSecondary)
        }
        .width('100%')

        // ÂïÜÂìÅÂàóË°®
        List({ space: AppDimensions.spaceSmall }) {
          ForEach(this.flashSaleGoods, (goods: Goods) => {
            ListItem() {
              this.FlashSaleItem(goods)
            }
          })
        }
        .listDirection(Axis.Horizontal)
        .scrollBar(BarState.Off)
        .width('100%')
        .height(180)
      }
    }
    .width('100%')
    .backgroundColor(AppColors.surface)
    .borderRadius(AppDimensions.radiusMedium)
    .padding(AppDimensions.paddingLarge)
  }

  // ÈôêÊó∂Á≤æÈÄâÂïÜÂìÅÈ°π
  @Builder
  FlashSaleItem(goods: Goods) {
    Column({ space: AppDimensions.spaceSmall }) {
      Image(goods.mainPic)
        .width(120)
        .height(120)
        .borderRadius(AppDimensions.radiusSmall)
        .objectFit(ImageFit.Cover)

      Text(goods.name)
        .fontSize(AppTypography.fontSizeMedium)
        .fontColor(AppColors.textPrimary)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width(120)

      Text(`¬•${(goods.price / 100).toFixed(2)}`)
        .fontSize(AppTypography.fontSizeMedium)
        .fontColor(AppColors.price)
        .fontWeight(AppTypography.fontWeightBold)
    }
  }

  // Êé®ËçêÂïÜÂìÅ
  @Builder
  RecommendSection() {
    Column({ space: AppDimensions.spaceMedium }) {
      this.SectionTitle('Êé®ËçêÂïÜÂìÅ')

      Column({ space: AppDimensions.spaceMedium }) {
        ForEach(this.recommendGoods, (goods: Goods) => {
          this.GoodsListItem(goods)
        })
      }
    }
  }

  // ÂÖ®ÈÉ®ÂïÜÂìÅ
  @Builder
  AllGoodsSection() {
    Column({ space: AppDimensions.spaceMedium }) {
      this.SectionTitle('ÂÖ®ÈÉ®ÂïÜÂìÅ')

      // ‰ΩøÁî®WaterFlowÁÄëÂ∏ÉÊµÅÂ∏ÉÂ±Ä
      WaterFlow() {
        ForEach(this.goods, (goods: Goods) => {
          FlowItem() {
            this.GoodsGridItem(goods)
          }
        })
      }
      .columnsTemplate('1fr 1fr')
      .rowsGap(AppDimensions.spaceMedium)
      .columnsGap(AppDimensions.spaceMedium)
      .width('100%')
    }
  }

  // ÂïÜÂìÅÂàóË°®È°π
  @Builder
  GoodsListItem(goods: Goods) {
    Row({ space: AppDimensions.spaceMedium }) {
      Image(goods.mainPic)
        .width(100)
        .height(100)
        .borderRadius(AppDimensions.radiusSmall)
        .objectFit(ImageFit.Cover)

      Column({ space: AppDimensions.spaceSmall }) {
        Text(goods.name)
          .fontSize(AppTypography.fontSizeMedium)
          .fontColor(AppColors.textPrimary)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row({ space: AppDimensions.spaceXSmall }) {
          Text(`¬•${(goods.price / 100).toFixed(2)}`)
            .fontSize(AppTypography.fontSizeLarge)
            .fontColor(AppColors.price)
            .fontWeight(AppTypography.fontWeightBold)

          if (goods.originalPrice) {
            Text(`¬•${(goods.originalPrice / 100).toFixed(2)}`)
              .fontSize(AppTypography.fontSizeSmall)
              .fontColor(AppColors.textTertiary)
              .decoration({ type: TextDecorationType.LineThrough })
          }
        }

        if (goods.sales) {
          Text(`Â∑≤ÂîÆ ${goods.sales}`)
            .fontSize(AppTypography.fontSizeSmall)
            .fontColor(AppColors.textSecondary)
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(AppColors.surface)
    .borderRadius(AppDimensions.radiusMedium)
    .padding(AppDimensions.paddingMedium)
  }

  // ÂïÜÂìÅÁΩëÊ†ºÈ°π
  @Builder
  GoodsGridItem(goods: Goods) {
    Column({ space: AppDimensions.spaceSmall }) {
      Image(goods.mainPic)
        .width('100%')
        .aspectRatio(1)
        .borderRadius(AppDimensions.radiusSmall)
        .objectFit(ImageFit.Cover)

      Column({ space: AppDimensions.spaceXSmall }) {
        Text(goods.name)
          .fontSize(AppTypography.fontSizeMedium)
          .fontColor(AppColors.textPrimary)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(`¬•${(goods.price / 100).toFixed(2)}`)
          .fontSize(AppTypography.fontSizeMedium)
          .fontColor(AppColors.price)
          .fontWeight(AppTypography.fontWeightBold)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor(AppColors.surface)
    .borderRadius(AppDimensions.radiusMedium)
    .padding(AppDimensions.paddingSmall)
  }

  // ÂàÜÊÆµÊ†áÈ¢ò
  @Builder
  SectionTitle(title: string) {
    Row() {
      Divider()
        .strokeWidth(2)
        .color(AppColors.primary)
        .width(4)
        .vertical(false)

      Text(title)
        .fontSize(AppTypography.fontSizeLarge)
        .fontWeight(AppTypography.fontWeightMedium)
        .fontColor(AppColors.textPrimary)
        .margin({ left: AppDimensions.spaceSmall })
    }
    .width('100%')
  }
}
