/**
 * è´­ç‰©è½¦é¡µ
 */
import { TopAppBar } from '../components/TopAppBar';
import { AppColors } from '../theme/AppColors';
import { AppDimensions } from '../theme/AppDimensions';
import { AppTypography } from '../theme/AppTypography';
import { mockCart } from '../data/MockData';
import { Cart, CartSpec } from '../models/CommonModels';

@Component
export struct CartPage {
  @State cartItems: Cart[] = mockCart;
  @State isEmpty: boolean = false;
  @State isEditing: boolean = false;
  @State selectedItems: Map<number, Set<number>> = new Map(); // goodsId -> Set<specId>
  @State isAllSelected: boolean = false;
  @State selectedCount: number = 0;
  @State totalAmount: number = 0;

  aboutToAppear() {
    this.isEmpty = this.cartItems.length === 0;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      TopAppBar({
        title: 'è´­ç‰©è½¦',
        actions: () => {
          if (!this.isEmpty) {
            this.TopBarActions()
          }
        }
      })

      if (this.isEmpty) {
        // ç©ºè´­ç‰©è½¦
        this.EmptyCart()
      } else {
        // æœ‰å•†å“çš„è´­ç‰©è½¦
        Column() {
          // å•†å“åˆ—è¡¨
          this.CartList()

          // åº•éƒ¨ç»“ç®—æ 
          this.BottomBar()
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.background)
  }

  // é¡¶éƒ¨æ æ“ä½œæŒ‰é’®
  @Builder
  TopBarActions() {
    Text(this.isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘')
      .fontSize(AppTypography.fontSizeMedium)
      .fontColor(AppColors.textPrimary)
      .onClick(() => {
        this.isEditing = !this.isEditing;
      })
  }

  // ç©ºè´­ç‰©è½¦
  @Builder
  EmptyCart() {
    Column({ space: AppDimensions.spaceLarge }) {
      Text('ðŸ›’')
        .fontSize(80)
        .opacity(0.3)

      Text('è´­ç‰©è½¦æ˜¯ç©ºçš„')
        .fontSize(AppTypography.fontSizeLarge)
        .fontColor(AppColors.textSecondary)

      Text('å¿«åŽ»æ·»åŠ å•†å“å§')
        .fontSize(AppTypography.fontSizeMedium)
        .fontColor(AppColors.textTertiary)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
  }

  // è´­ç‰©è½¦åˆ—è¡¨
  @Builder
  CartList() {
    List({ space: AppDimensions.spaceMedium }) {
      ForEach(this.cartItems, (cart: Cart) => {
        ListItem() {
          this.CartItem(cart)
        }
      })
    }
    .layoutWeight(1)
    .padding(AppDimensions.paddingMedium)
    .scrollBar(BarState.Off)
  }

  // è´­ç‰©è½¦å•†å“é¡¹
  @Builder
  CartItem(cart: Cart) {
    Column({ space: AppDimensions.spaceSmall }) {
      ForEach(cart.spec, (spec: CartSpec) => {
        Row({ space: AppDimensions.spaceMedium }) {
          // é€‰æ‹©æ¡†
          Checkbox()
            .select(this.isSpecSelected(cart.goodsId, spec.id))
            .onChange((value: boolean) => {
              this.toggleSpecSelection(cart.goodsId, spec.id);
            })

          // å•†å“å›¾ç‰‡
          Image(cart.goodsMainPic)
            .width(80)
            .height(80)
            .borderRadius(AppDimensions.radiusSmall)
            .objectFit(ImageFit.Cover)

          // å•†å“ä¿¡æ¯
          Column({ space: AppDimensions.spaceSmall }) {
            Text(cart.goodsName)
              .fontSize(AppTypography.fontSizeMedium)
              .fontColor(AppColors.textPrimary)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            Text(spec.specName)
              .fontSize(AppTypography.fontSizeSmall)
              .fontColor(AppColors.textSecondary)
              .padding(AppDimensions.paddingXSmall)
              .backgroundColor(AppColors.surfaceVariant)
              .borderRadius(AppDimensions.radiusSmall)

            Row() {
              Text(`Â¥${(spec.price / 100).toFixed(2)}`)
                .fontSize(AppTypography.fontSizeLarge)
                .fontColor(AppColors.price)
                .fontWeight(AppTypography.fontWeightBold)

              Blank()

              // æ•°é‡æŽ§åˆ¶å™¨
              Row({ space: AppDimensions.spaceSmall }) {
                Text('âˆ’')
                  .fontSize(20)
                  .fontColor(spec.count > 1 ? AppColors.textPrimary : AppColors.textTertiary)
                  .width(24)
                  .height(24)
                  .textAlign(TextAlign.Center)
                  .border({ width: 1, color: AppColors.border, radius: 4 })
                  .onClick(() => {
                    if (spec.count > 1) {
                      spec.count--;
                      this.calculateTotal();
                    }
                  })

                Text(spec.count.toString())
                  .fontSize(AppTypography.fontSizeMedium)
                  .fontColor(AppColors.textPrimary)
                  .width(30)
                  .textAlign(TextAlign.Center)

                Text('+')
                  .fontSize(20)
                  .fontColor(spec.count < spec.stock ? AppColors.textPrimary : AppColors.textTertiary)
                  .width(24)
                  .height(24)
                  .textAlign(TextAlign.Center)
                  .border({ width: 1, color: AppColors.border, radius: 4 })
                  .onClick(() => {
                    if (spec.count < spec.stock) {
                      spec.count++;
                      this.calculateTotal();
                    }
                  })
              }
            }
            .width('100%')
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')
        .backgroundColor(AppColors.surface)
        .borderRadius(AppDimensions.radiusMedium)
        .padding(AppDimensions.paddingMedium)
      })
    }
  }

  // åº•éƒ¨ç»“ç®—æ 
  @Builder
  BottomBar() {
    Row() {
      // å…¨é€‰
      Row({ space: AppDimensions.spaceSmall }) {
        Checkbox()
          .select(this.isAllSelected)
          .onChange((value: boolean) => {
            this.toggleSelectAll();
          })

        Text('å…¨é€‰')
          .fontSize(AppTypography.fontSizeMedium)
          .fontColor(AppColors.textPrimary)
      }

      Blank()

      if (!this.isEditing) {
        // ç»“ç®—æ¨¡å¼
        Row({ space: AppDimensions.spaceSmall }) {
          Text('åˆè®¡:')
            .fontSize(AppTypography.fontSizeMedium)
            .fontColor(AppColors.textPrimary)

          Text(`Â¥${(this.totalAmount / 100).toFixed(2)}`)
            .fontSize(AppTypography.fontSizeXLarge)
            .fontColor(AppColors.price)
            .fontWeight(AppTypography.fontWeightBold)

          Button(this.selectedCount > 0 ? `ç»“ç®—(${this.selectedCount})` : 'ç»“ç®—')
            .fontSize(AppTypography.fontSizeMedium)
            .backgroundColor(this.selectedCount > 0 ? AppColors.primary : AppColors.textTertiary)
            .fontColor(AppColors.onPrimary)
            .borderRadius(AppDimensions.radiusLarge)
            .padding({
              left: AppDimensions.paddingLarge,
              right: AppDimensions.paddingLarge
            })
            .enabled(this.selectedCount > 0)
        }
      } else {
        // ç¼–è¾‘æ¨¡å¼
        Button(this.selectedCount > 0 ? `åˆ é™¤(${this.selectedCount})` : 'åˆ é™¤')
          .fontSize(AppTypography.fontSizeMedium)
          .backgroundColor(this.selectedCount > 0 ? AppColors.error : AppColors.textTertiary)
          .fontColor(AppColors.onPrimary)
          .borderRadius(AppDimensions.radiusLarge)
          .padding({
            left: AppDimensions.paddingLarge,
            right: AppDimensions.paddingLarge
          })
          .enabled(this.selectedCount > 0)
          .onClick(() => {
            this.deleteSelected();
          })
      }
    }
    .width('100%')
    .height(60)
    .backgroundColor(AppColors.surface)
    .padding({
      left: AppDimensions.paddingLarge,
      right: AppDimensions.paddingLarge
    })
    .border({
      width: { top: 1 },
      color: AppColors.border
    })
  }

  // åˆ¤æ–­è§„æ ¼æ˜¯å¦é€‰ä¸­
  isSpecSelected(goodsId: number, specId: number): boolean {
    const specs = this.selectedItems.get(goodsId);
    return specs ? specs.has(specId) : false;
  }

  // åˆ‡æ¢è§„æ ¼é€‰ä¸­çŠ¶æ€
  toggleSpecSelection(goodsId: number, specId: number) {
    if (!this.selectedItems.has(goodsId)) {
      this.selectedItems.set(goodsId, new Set());
    }
    const specs = this.selectedItems.get(goodsId)!;
    if (specs.has(specId)) {
      specs.delete(specId);
    } else {
      specs.add(specId);
    }
    this.calculateTotal();
    this.checkAllSelected();
  }

  // åˆ‡æ¢å…¨é€‰
  toggleSelectAll() {
    this.isAllSelected = !this.isAllSelected;
    if (this.isAllSelected) {
      // å…¨é€‰
      this.cartItems.forEach(cart => {
        const specs = new Set<number>();
        cart.spec.forEach(spec => specs.add(spec.id));
        this.selectedItems.set(cart.goodsId, specs);
      });
    } else {
      // å–æ¶ˆå…¨é€‰
      this.selectedItems.clear();
    }
    this.calculateTotal();
  }

  // æ£€æŸ¥æ˜¯å¦å…¨é€‰
  checkAllSelected() {
    let totalSpecs = 0;
    let selectedSpecs = 0;
    this.cartItems.forEach(cart => {
      totalSpecs += cart.spec.length;
      const specs = this.selectedItems.get(cart.goodsId);
      if (specs) {
        selectedSpecs += specs.size;
      }
    });
    this.isAllSelected = totalSpecs > 0 && totalSpecs === selectedSpecs;
  }

  // è®¡ç®—æ€»ä»·å’Œæ•°é‡
  calculateTotal() {
    let count = 0;
    let amount = 0;
    this.selectedItems.forEach((specs, goodsId) => {
      const cart = this.cartItems.find(c => c.goodsId === goodsId);
      if (cart) {
        cart.spec.forEach(spec => {
          if (specs.has(spec.id)) {
            count += spec.count;
            amount += spec.price * spec.count;
          }
        });
      }
    });
    this.selectedCount = count;
    this.totalAmount = amount;
  }

  // åˆ é™¤é€‰ä¸­é¡¹
  deleteSelected() {
    this.cartItems = this.cartItems.filter(cart => {
      const specs = this.selectedItems.get(cart.goodsId);
      if (!specs) return true;
      cart.spec = cart.spec.filter(spec => !specs.has(spec.id));
      return cart.spec.length > 0;
    });
    this.selectedItems.clear();
    this.isEmpty = this.cartItems.length === 0;
    this.isEditing = false;
    this.calculateTotal();
  }
}

